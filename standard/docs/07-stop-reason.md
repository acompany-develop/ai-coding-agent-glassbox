# 07. stop_reason による状態遷移

エージェントループの継続・終了を制御する仕組みです。

## stop_reason とは

LLM レスポンスに含まれる「終了理由」です。

```python
@dataclass
class LLMResponse:
    text: str | None
    tool_calls: list[ToolCall]
    stop_reason: str  # "tool_use" or "end_turn"
    raw_response: Any
```

## 状態遷移図

```
                    ┌─────────────────────────────────────────┐
                    │          Agent Loop Start               │
                    └─────────────────────────────────────────┘
                                       │
                                       ▼
                    ┌─────────────────────────────────────────┐
                    │          THINK: LLM 呼び出し             │
                    └─────────────────────────────────────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │     stop_reason は？    │
                         └─────────────────────────┘
                          │                       │
              ┌───────────┘                       └───────────┐
              │                                               │
              ▼                                               ▼
┌─────────────────────────────┐             ┌─────────────────────────────┐
│   stop_reason: "tool_use"   │             │   stop_reason: "end_turn"   │
│                             │             │                             │
│ LLM がツールを呼びたい      │             │ LLM がタスク完了と判断      │
│ → ACT フェーズへ           │             │ → ループ終了               │
└─────────────────────────────┘             └─────────────────────────────┘
              │                                               │
              ▼                                               ▼
┌─────────────────────────────┐             ┌─────────────────────────────┐
│   ACT: ツール実行           │             │   最終レスポンスを返す      │
│                             │             │                             │
│ (ask_user の場合は          │             │ return response.text        │
│  ユーザー入力を待つ)        │             │                             │
└─────────────────────────────┘             └─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   OBSERVE: 結果を履歴に追加 │
└─────────────────────────────┘
              │
              └──────────────────┐
                                 │
                                 ▼
                    ┌─────────────────────────────────────────┐
                    │          THINK: LLM 呼び出し（次）       │
                    └─────────────────────────────────────────┘
```

## ask_user での特殊な挙動

`ask_user` ツールは ACT フェーズでユーザー入力を待ちます。

```
┌─────────────────────────────────────────────────────────────┐
│  Iteration N                                                │
│                                                             │
│  THINK:                                                     │
│    LLM: "削除前にユーザーに確認します"                       │
│    tool_calls: [{name: "ask_user", input: {...}}]          │
│    stop_reason: "tool_use"                                 │
│                                                             │
│  ACT:                                                       │
│    ask_user.execute() が呼ばれる                            │
│    ┌─────────────────────────────────────────────────┐     │
│    │ [ASK USER] 削除してよいですか？                 │     │
│    │   1. はい                                       │     │
│    │   2. いいえ                                     │     │
│    │ 選択 (番号): _                                  │     │
│    └─────────────────────────────────────────────────┘     │
│    ↓ ユーザーが "1" を入力                                  │
│    result = "はい"                                         │
│                                                             │
│  OBSERVE:                                                   │
│    message_history.add_tool_result(..., "はい")            │
└─────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│  Iteration N+1                                              │
│                                                             │
│  THINK:                                                     │
│    LLM: ユーザーが "はい" と答えたことを認識                 │
│    → 削除を実行                                            │
└─────────────────────────────────────────────────────────────┘
```

## 状態遷移表

| 現在の状態 | stop_reason | tool_calls | 次の状態 |
|-----------|-------------|------------|---------|
| THINK | `"tool_use"` | あり | ACT → OBSERVE → THINK |
| THINK | `"end_turn"` | なし | END（ループ終了） |
| THINK | 任意 | なし | END（ループ終了） |

## 各プロバイダーの stop_reason

| プロバイダー | ツール呼び出し時 | タスク完了時 |
|-------------|----------------|-------------|
| Gemini | `"tool_use"` | `"end_turn"` |
| Llama | `"tool_use"` | `"end_turn"` |

## 関連ドキュメント

- [01-agent-loop.md](./01-agent-loop.md) - ループ全体の流れ
- [05-tools-extended.md](./05-tools-extended.md) - ask_user ツールの詳細
